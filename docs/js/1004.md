---
title: HTTP 缓存
---

# HTTP 缓存

## 缓存的种类

- 私有缓存

  > (私有)浏览器缓存

- 共享缓存
  > (共享)代理缓存,共享缓存可以被多个用户使用。例如，ISP 或你所在的公司可能会架设一个 web 代理来作为本地网络基础的一部分提供给用户。这样热门的资源就会被重复使用，减少网络拥堵与延迟。

## 缓存控制

### Cache-control

> HTTP/1.1 定义的 Cache-Control 头用来区分对缓存机制的支持情况， 请求头和响应头都支持这个属性

- no-store 无缓存
- no-cache 协商缓存
- public
- private
- max-age 过期 max-age=seconds 相对 Expires 而言，max-age 是距离请求发起的时间的秒数。
- must-revalidate 验证方式

### Pragma

> 是 HTTP/1.0 标准中定义的一个 header 属性，请求中包含 Pragma 的效果跟在头信息中定义 <b>Cache-Control: no-cache </b>相同，但是 HTTP 的响应头没有明确定义这个属性，所以它不能拿来完全替代 HTTP/1.1 中定义的 Cache-control 头。通常定义 Pragma 以向后兼容基于 HTTP/1.0 的客户端。

## 缓存有效性

当客户端发起一个请求时，缓存检索到已有缓存副本，则此请求会附加 If-None-Match 头， 以此判断缓存是否有效，若服务器返回了 304 (Not Modified)（该响应不会有带有实体信息），这样一来，可以节省一些带宽。若服务器通过 If-None-Match 或 If-Modified-Since 判断后发现已过期，那么会带有该资源的实体内容返回。

### 缓存寿命

Cache-control: max-age=N 的头，相应的缓存的寿命就是 N。通常 不含这个属性的请求则会去查看是否包含 Expires 属性，通过比较 Expires 的值和头里面 Date 属性的值来判断是否缓存还有效。如果 max-age 和 expires 属性都没有，找头里的 Last-Modified 信息。如果有，缓存的寿命就等于头里面 Date 的值减去 Last-Modified 的值除以 10

## 缓存验证

如果缓存的响应头信息里含有"Cache-control: must-revalidate”的定义，在浏览的过程中也会触发缓存验证。另外，在浏览器偏好设置里设置 Advanced->Cache 为强制验证缓存也能达到相同的效果。

当缓存的文档过期后，需要进行缓存验证或者重新获取资源。只有在服务器返回强校验器或者弱校验器时才会进行验证。

### 强校验器

- ETag 如果资源请求的响应头里含有 ETag, 客户端可以在后续的请求的头中带上 If-None-Match 头来验证缓存。

### 弱校验器

- Last-Modified 响应头可以作为一种弱校验器。 它只能精确到秒。如果响应头里含有这个信息，客户端可以在后续的请求中带上 If-Modified-Since 来验证缓存。

## Vary

Vary HTTP 响应头决定了对于后续的请求头，如何判断是请求一个新的资源还是使用缓存的文件。

> 只有当前的请求和原始（缓存）的请求头跟缓存的响应头里的 Vary 都匹配，才能使用缓存的响应。使用 vary 头有利于内容服务的动态多样性。例如，使用 Vary: User-Agent 头，缓存服务器需要通过 UA 判断是否使用缓存的页面。如果需要区分移动端和桌面端的展示内容，利用这种方式就能避免在不同的终端展示错误的布局。另外，它可以帮助搜索引擎更好地发现页面的移动版本

|         | http 版本      | 描述                                                               |
| ------- | -------------- | ------------------------------------------------------------------ |
| Expires | HTTP1.0        | 绝对时间，如果服务端和客户端的时间产生偏差，会导致命中缓存产生偏差 |
| Pragma  | HTTP1.0        | 同 Cache-control:no-cache                                          |
| 键顺序  | 无序（ECM      | 顺序                                                               |
| Size    | 无             | 有                                                                 |
| 迭代    | 先获取键在迭代 | 可迭代                                                             |
| 性能    | 频繁操作无优化 | 频繁操作有优化                                                     |
