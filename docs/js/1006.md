---
title: HTTP 条件请求
---

# HTTP 条件请求

> 请求的结果，甚至请求成功的状态，都会随着验证器与受影响资源的比较结果的变化而变化。
> 这类请求可以用来验证缓存的有效性，省去不必要的控制手段，以及验证文件的完整性，例如在断点续传的场景下或者在上传或者修改服务器端的文件的时候避免更新丢失问题。

## 基本原理

> 条件请求指的是请求的执行结果会因特定首部的值不同而不同

- 对于安全（safe）方法来说

  > 例如 GET，通常用来获取文件，条件请求可以被用来限定仅在满足条件的情况下返回文件。这样可以节省带宽

- 对于非安全（unsafe）方法
  > 例如 PUT 方法，通常用来上传文件，条件请求可以被用来限定仅在满足文件的初始版本与服务器上的版本相同的条件下才会将其上传。

## 验证器

### 验证器的类型

- 文件的最后修改时间，即 last-modified （最后修改）时间
- “实体标签”，或者 etag

### 验证类型

> 验证类型与验证器的类型是相互独立的。 Last-Modified 和 ETag 首部均可应用于两种验证类型，尽管在服务器端实现的复杂程度可能会有所不同。HTTP 协议默认使用强验证类型，可以指定何时使用弱验证类型。

#### 强验证类型

> 应用于需要逐个字节相对应的情况，例如需要进行断点续传的时候

#### 弱验证类型

> 应用于用户代理只需要确认资源内容相同即可。即便是有细微差别也可以接受，比如显示的广告不同，或者是页脚的时间不同

## 条件首部

|                     | 验证类型           | 匹配成功                                                  |
| ------------------- | ------------------ | --------------------------------------------------------- |
| If-Match            | 强校验除非 W/ 前缀 | 远端资源的实体标签与在 ETag 这个首部中列出的值相同        |
| If-None-Match       | 强校验除非 W/ 前缀 | 同上 - 值不相同                                           |
| If-Modified-Since   |                    | 远端资源的 Last-Modified 首部标识的日期比在该首部中的值晚 |
| If-Unmodified-Since |                    | 同上 - 早或相同                                           |
| If-Range            |                    | 与 If-Match 或 If-Unmodified-Since 相似                   |

> If-Range 是只能含有一个实体标签或者日期值。如果匹配失败，则条件请求宣告失败，此时将不会返回 206 Partial Content 响应码，而是返回 200 OK 响应码，以及完整的资源。

## 应用场景

### [缓存更新](/js/1004.html)

### 使用乐观锁避免更新丢失问题

（大多数 wiki 系统和版本管理系统采用的是该算法）

这种方式的实现需要用到 If-Match 或 If-Unmodified-Since 首部。假如实体标签与源头文件的实体标签不一致，或者源头文件在被获取副本之后经过了修改，那么此次变更请求就会被拒绝，收到 <b>412</b>（先决条件失败） 的错误提示。之后就需要依靠客户端来处理该错误了：或者通知用户重新开始（基于最新的版本），或者是给用户展示两个版本之间的差异，辅助他们决定要保留哪些变更。
